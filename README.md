# 30. Sql Error Handling
- error ek event hai,jise aap exception bhi keh sakte hai.
- Error/Exception ke wajah se aap ka pgm ka execution terminate ho jata hai.
- To handle this we have try-catch block.
- we can create custom error/message via Throw block.
- ***REMEMER : Return Error Info slide*** eg Error_Number() yadi aap catch block ke bahar use karte hai to return null.

![Alt text](image.png)![Alt text](image-1.png)![Alt text](image-2.png)
```sql
use  MyDatabase;
/*
	Type of Sql Server Error/Exception
		1) System Defined Error:
			In a System Defined Exception the exceptions(errors) are generated by 
			  the system.
*/
Declare @val1 Int;
Declare @Val2 Int; --Declaration of variables val1 and val2

Begin Try  -- Try block beggining
	
	Set @val1 = 8;
	Set @Val2 = @val1 / 0 ; --Divide by 0 leads to exception
	Print 'Line1';
	Print 'Line2';
	Print 'Line3';

End Try  -- Try block end
Begin Catch -- similar for catch block

	Print 'Inside Catch block';
	Print  Concat('Error message = ',Error_Message());
	Print  Concat('Error Line = ',Error_Line());
	Print  Concat('Error Number = ',Error_Number());
	Print  Concat('Error Severity = ',Error_Severity());
	Print  Concat('Error state = ',Error_State());
	Print  Concat('Error Procedure = ',Error_Procedure());

End Catch
/*
Inside Catch block
Error message = Divide by zero error encountered.
Error Line = 7
Error Number = 8134
Error Severity = 16
Error state = 1
Error Procedure = 
*/
```
![Alt text](image-3.png)
```sql
Declare @val1 Int;
Declare @Val2 Int; 

Begin Try  
	
	Print 'Inside Try block';
	Set @val1 = 8;	
	Print 'Line1';
	Print 'Line2';
	Set @Val2 = @val1 / 2 ;
	Print 'Line3';

End Try  
Begin Catch 

	Print 'Inside Catch block';
	Print  Concat('Error message = ',Error_Message());
	Print  Concat('Error Line = ',Error_Line());
	Print  Concat('Error Number = ',Error_Number());
	Print  Concat('Error Severity = ',Error_Severity());
	Print  Concat('Error state = ',Error_State());
	Print  Concat('Error Procedure = ',Error_Procedure());

End Catch
/*
Inside Try block
Line1
Line2
Line3
*/
```
### User Defined Error
- kabhi kabhi requirement ke hisab se hume error ko explicitly throw karna hota hai, in that case we defined the custom error.
- for this we use Throw keyword
- isme 3 parameter hote hai ==> errorNumber,errorMessage and errorSeverity
- ***Remeber*** ErrorNumber aapka 50000 se start hota hai
- kyuki 50000 ke niche ki value sql ke apne error number ke liye reserve hai.
```sql
/*
	Type of Sql Server Error/Exception
	  2) User Defined Error:
		The Throw statement in sql Server raises an exception and transfers the control
			to a Catch block.
		Syntax :
			Throw @errorNumber,@errorMessage,@errorSeverity

		Error No --> 50000 to 2147483647

		Error Severity :
			13 --> Indicate transaction deadlock errors.
			14 --> Indicate security related errors, such as permission denied.
			15 --> Indicate syntax errors in a Transact-Sql statement.
			16 --> Indicate generals errors that can be corrected by the user.

Target:
  Yadi Age 40 se jyda hai, to error throw ho jave
   and age 40 se kum hai tab error skip.
*/
Declare @Age Int; 

Begin Try  

	Print 'Inside Try block';
	Set @Age=60;	
	Print 'Line1';
	Print 'Line2';
	If @Age > 40
		--Throw @errorNumber,@errorMessage,@errorSeverity
		  Throw  50000,'Age is greater than 40',16;
	
	Print 'Line3';
	Print 'Line4';

End Try  
Begin Catch 

	Print 'Inside Catch block';
	Print  Concat('Error message = ',Error_Message());
	Print  Concat('Error Line = ',Error_Line());
	Print  Concat('Error Number = ',Error_Number());
	Print  Concat('Error Severity = ',Error_Severity());
	Print  Concat('Error state = ',Error_State());
	Print  Concat('Error Procedure = ',Error_Procedure());

End Catch
/*
Inside Try block
Line1
Line2

Inside Catch block
Error message = Age is greater than 40
Error Line = 11
Error Number = 50000
Error Severity = 16
Error state = 16
Error Procedure = 

What happen, jab aap Throw statement naal
  ErrorNumber less than 50K use karo toh
*/
Declare @Age1 Int; 

Begin Try  

	Print 'Inside Try block';
	Set @Age1=60;	
	Print 'Line1';
	Print 'Line2';
	If @Age1 > 40
		  Throw  40000,'Age1 is greater than 40',16;
	
	Print 'Line3';
	Print 'Line4';

End Try  
Begin Catch 

	Print 'Inside Catch block';
	Print  Concat('Error message = ',Error_Message());
	Print  Concat('Error Line = ',Error_Line());
	Print  Concat('Error Number = ',Error_Number());
	Print  Concat('Error Severity = ',Error_Severity());
	Print  Concat('Error state = ',Error_State());
	Print  Concat('Error Procedure = ',Error_Procedure());

End Catch
/*
Inside Try block
Line1
Line2

Inside Catch block

Error message = Error number 40000 in the THROW statement is outside the valid range.
				Specify an error number in the valid range of 50000 to 2147483647.

Error Line = 10
Error Number = 35100
Error Severity = 16
Error state = 10
Error Procedure = 

Output: mein Error message aa gya hai
   jo bol raha hai, u must specify the valid range of user defined error
*/
```
### Raiserror
- You can also use raiseerror instead of throw statement
- Diff is that Raiserror aapka without try-catch use kiya ja sakta hai
- but throw statement ke liye aapko try-catch mandatory hai.
- Syntax mein bhi diff hai
- Raiserror(errorMessage,Severity,errorState)
- jabki throw(errorNumber,errorMessage,errorSeverity)
- yadi aapko Begin try use nhi karna hai to go for Raiserror
#### Raiserror kab use hota hai?
- aap kisi application se koyi falana procedure ko call kar rahe hai.
- aur us falana procedure se koyi message yadi aapko calling application ko pahuchana raha 
- us case mein u use raiserror.
```sql
Declare @Age2 Int; 

Begin Try  
	Print 'Inside Try block';
	Set @Age2=60;	
	Print 'Line1';
	Print 'Line2';
	If @Age2 > 40
		RAISERROR('Age2 is greater than 40',16,3);	
		-- Throw  50000,'Age2 is greater than 40',16;		 		
	
	Print 'Line3';
	Print 'Line4';
End Try  

Begin Catch 
	Print 'Inside Catch block';
	Print  Concat('Error message = ',Error_Message());
	Print  Concat('Error Line = ',Error_Line());
	Print  Concat('Error Number = ',Error_Number());
	Print  Concat('Error Severity = ',Error_Severity());
	Print  Concat('Error state = ',Error_State());
	Print  Concat('Error Procedure = ',Error_Procedure());
End Catch
/*
Inside Try block
Line1
Line2
Inside Catch block
Error message = Age2 is greater than 40
Error Line = 10
Error Number = 50000
Error Severity = 16
Error state = 3
Error Procedure = 
*/
```
# 31. Sql Dirty Read in Concurrent Transaction
#### What is Transition?
- sequence of operation 
- mane multiple sql statement(data ko write/update/delete etc)
- jab ye sare multiple operation as a single unit execute hote hai ussse kehete hai transition.
- 1 transition mein multiple or single operation i.e sql statement ho sakte hai
- Transition ki property hoti hai
- ya to sare statements execute honge tab transtion save/success ie. commit.
- or ek bhi statement execute nhi hua tab transition fail/cancel i.e Rollback

![Alt text](image-4.png)
### What is Dirty read?
- aapke sql server par yadi multiple transaction execute ho rahi hai, tab dirty read ki probability badh sakti hai.
- In dig, apne pass 2 transaction hai
- yadi 2no transaction db mein same table ko update aur read kar rahe hai.
- figure out dig, transaction 10 hai aur sala 9 read kar liya ho gya dirty read.
- i.e transaction 1 ka data rollback hone ke pehle transaction 2 ne data read kar liya called as dirty read.

![Alt text](image-5.png)
### What is Isolation level?
- ye ek property hai sql transaction ki.
- Yadi koyi transaction data ko write/update karti hai to dusri transaction us data ko tabhi read kar pavengi 
- jab pehli transaction usse commit kar de.
- dig mein level di gyi hai isolation level
- by default hamara read committed hota hai.

![Alt text](image-6.png)
### Transaction in 1st window 
```sql
-- Transaction 1
use MyDatabase;

select salary,* from Employee1;
/*
3000	1001	2020-09-24 12:11:30.233	John	Yang	1		3000	2021	1		1
4000	1002	2020-04-11 11:12:35.233	Smith	Ting	2		4000	2020	3		2
6000	1003	2020-03-03 09:11:30.233	King	Amaze	4		6000	2019	2		4
5500	1004	2020-02-22 09:11:30.233	Millia	King	7		5500	2021	5		8
5500	1005	2020-01-15 12:11:30.233	Linda	Reina	4		5500	2022	5		6
5500	1006	2020-05-09 09:11:30.233	Tony	Blele	2		5500	1990	3		4
7800	1007	2020-09-12 12:11:30.233	Joshep	Desuja	5		7800	2020	4		8
2100	1009	2020-09-11 06:11:30.233	Alice	Rocky	6		2100	2021	6		3
2200	1009	2020-09-12 05:11:30.233	Mangu	Desa	6		2200	2022	8		7
1100	1010	2020-09-12 04:11:30.233	David	Kulum	7		1100	2022	2		7
NULL	NULL	2020-09-12 06:11:30.233	NULL	NULL	NULL	NULL	NULL	NULL	NULL

Lets Update the salary
Eg : of Dirty Read
 ek transaction mein aap update kar rahe hai
 uske baad wo rollback hone se pehle 
 15 second wait karenga.
*/
Begin Tran
	Update Employee1 Set Salary= 4500 where empId=1001;
 WaitFor Delay '00:00:15'  -- wait for 15 seconds delay
 RollBack Tran -- after delay rollback the transaction
 -- 1 row affected
```
###  Transaction in 2nd window 
```sql
-- Transaction 2

use MyDatabase;

--Now read in this transaction
Select salary,* from Employee1 where empId=1001;
/*
3000	1001	2020-09-24 12:11:30.233	John	Yang	1	3000	2021	1	1

isne 15 min delay kiya,
jab transaction in 1st window commit hua 
 after than isne chalaya apna transaction.

 or
*/
Set Tran Isolation level Read Committed
Select salary,* from Employee1 where empId=1001;
/*
3000	1001	2020-09-24 12:11:30.233	John	Yang	1	3000	2021	1	1

same description as above 

ye isolation level Read committed by default hota hai.
*/
```
#### by default tranasction ki property read committed rehti hai.
![Alt text](image-7.png)
### If you change the isolation level to Read Uncommitted then
```sql
-- Transaction 1
use MyDatabase;

select salary,* from Employee1;
/*
3000	1001	2020-09-24 12:11:30.233	John	Yang	1		3000	2021	1		1
4000	1002	2020-04-11 11:12:35.233	Smith	Ting	2		4000	2020	3		2
6000	1003	2020-03-03 09:11:30.233	King	Amaze	4		6000	2019	2		4
5500	1004	2020-02-22 09:11:30.233	Millia	King	7		5500	2021	5		8
5500	1005	2020-01-15 12:11:30.233	Linda	Reina	4		5500	2022	5		6
5500	1006	2020-05-09 09:11:30.233	Tony	Blele	2		5500	1990	3		4
7800	1007	2020-09-12 12:11:30.233	Joshep	Desuja	5		7800	2020	4		8
2100	1009	2020-09-11 06:11:30.233	Alice	Rocky	6		2100	2021	6		3
2200	1009	2020-09-12 05:11:30.233	Mangu	Desa	6		2200	2022	8		7
1100	1010	2020-09-12 04:11:30.233	David	Kulum	7		1100	2022	2		7
NULL	NULL	2020-09-12 06:11:30.233	NULL	NULL	NULL	NULL	NULL	NULL	NULL

*/
Begin Tran
	Update Employee1 Set Salary= 4500 where empId=1001;
 WaitFor Delay '00:00:15'
 RollBack Tran 
```
### Transaction 2
```sql
-- Transaction 2

use MyDatabase;

Set Tran Isolation level Read UnCommitted
Select salary,* from Employee1 where empId=1001;
/*
4500	1001	2020-09-24 12:11:30.233	John	Yang	1	4500	2021	1	1

	- Data commit hone se pehle isne uncommit data ko read kar liya.
	- This is the eg of Dirty read
*/
```
![Alt text](image-8.png)
### Ab 1st window ka transaction 15 second delay hone ke baad roll back ho gya, yadi hum phir se Read Uncommitted wala command cahlaye tab.
```sql
-- Transaction 2

use MyDatabase;

Set Tran Isolation level Read UnCommitted
Select salary,* from Employee1 where empId=1001;
/*
3000	1001	2020-09-24 12:11:30.233	John	Yang	1	3000	2021	1	1

Ab ye commit hone ke baad - data proper de raha hai
*/
```
![Alt text](image-9.png)
### No Lock ye bhi Read Uncommitted ka kam kar deta.
```sql
-- Transaction 2

use MyDatabase;


Select salary,* from Employee1(NoLock) where empId=1001;
/*

4500	1001	2020-09-24 12:11:30.233	John	Yang	1	4500	2021	1	1

or
Abhi hum isolation level committed kar rahe hai
 yani aap window 1 ka transaction jab commit honga tab ye output denga
work with NoLOck
*/
Set Tran Isolation level Read Committed
Select salary,* from Employee1(NoLock) where empId=1001;
/*
4500	1001	2020-09-24 12:11:30.233	John	Yang	1	4500	2021	1	1

koyi delay nahi
*/
```
#### Window 1 ke query same hai
![Alt text](image-10.png)
- ye bhi dirty read hai
- rollback hone ke baad normal execute karnege

![Alt text](image-11.png)
# 32. ACID properties
### What is transaction?
- group of sql statement jo ki as a single unit of work consider hoti hai.
- agar sari statement chal padi to data commit & trnasaction success.
- yadi 1 bhi statement fail hue to data rollback & transaction fail.

![Alt text](image-12.png)
### Properties of a transaction:
![Alt text](image-13.png)
### 1 Automicity
- means all or nothing
- sari unit or statements aapki sahi se execute hue to transition success and data commit.
- yadi 1 bhi statement has issue then vice versa.
- refer dig

![Alt text](image-14.png)
### 2 Consitency
- aap jab bhi koyi multiple transaction karte hai,to ek transaction ke baad mein
- uska jo state change hona chaiye db mein save/commit hona chaiye.
- aur dusri transaction ko tabhi visible ho jab uska state commit  ho. 
### or
- aap jab bhi koyi multiple transaction karte hai,
to ek transaction ke baad mein 
- uska state ye commit/save hona chaiye db mein
- dusre transaction pehle transaction ka state commit hone ke baad mein dikhe.

![Alt text](image-15.png)
- eg 
- Cust A ne Cust B ko 200 rs diye
- So A ka state pehle 800 tha abhi 600 ho gya 
- and B ka 500 tha abhi 700 ho gya.
- ab aapko 300 transfer karna hia, so cust B ko aapka abhi bal 600 visible hai.
### 3 isoloation
- multiple transaction ek mek ko disturb nhi karna chaiye.
![Alt text](image-16.png)
### 4. Durability
![Alt text](image-17.png)
# 33. Sql Cursor
### What is result Set?
- query fire karne ke baad
- i.e Select * from student_details
- jis format mein hume sari info display hoti hai
- usse hum result set kehte hai
- see dig.
- result set hamara row and col format mein hota hai.
- is result set mein student ki sari info hai.
### Now we have a requirement?
- hume marksheet display karni hai student ki
- hume 1 by 1 student ka data fetch karna honga
- uske marks ka total karna honga
- Based on that create Percentage and Grade
- So in order to traverse the result set we requre cursor.
- ***Remember :*** Cursor aapki system memory mein run hota hai
- boleto kafi sari memory occupie kar leta hai
- avoid it other wise performance issue.

![Alt text](image-18.png)![Alt text](image-19.png)
### What is Cursor?
- Select query ke sath jo result set aata hai wo cursor ke sath map ho jata hai called as Active data set.

![Alt text](image-20.png)
### Types of Cursor
![Alt text](image-21.png)
- Implicit Cursor mein sab kaam automatic ho jata hai (open and close)

![Alt text](image-22.png)![Alt text](image-23.png)![Alt text](image-24.png)
- static cursor => active data set ko cache mein rakhta hai, wahi se har row ko pic or process karta hai; Has Feture Current row to next/previous row.
- fast forward => refer dig
- dynamic => Jo bhi addition or deltion karte hai uska reflection db mein aa jata hai.
- for eg, yadi dusra user same table ko use kar raha hai, wo aapke changes dekh sakta hai.
- Keyset => opposite to dynamic. reflction db mein nhi aavenga.

![Alt text](image-25.png)
```sql
use MyDatabase;

create table Student_details
(
	rollNo Int Not Null,
	student_name Varchar(100) not null,
	class varchar(10) null,
	marks_science int not null,
	marks_maths int not null,
	marks_eng int not null
)

Insert Into Student_details Values(1,'Anil','5th',34,78,54);
Insert Into Student_details Values(2,'Sunil','7th',78,43,87);
Insert Into Student_details Values(3,'Ajay','5th',45,32,78);
Insert Into Student_details Values(4,'Vijay','4th',36,78,32);
Insert Into Student_details Values(5,'Manoj','5th',12,22,67);
Insert Into Student_details Values(6,'Geeta','8th',21,65,43);
Insert Into Student_details Values(7,'Sita','4th',34,78,54);
Insert Into Student_details Values(8,'Reeta','9th',89,78,54);
Insert Into Student_details Values(9,'Arvind','12th',78,78,54);
Insert Into Student_details Values(10,'Kumar','11th',22,56,54);

Select * from Student_details;
/*
1	Anil	5th		34	78	54
2	Sunil	7th		78	43	87
3	Ajay	5th		45	32	78
4	Vijay	4th		36	78	32
5	Manoj	5th		12	22	67
6	Geeta	8th		21	65	43
7	Sita	4th		34	78	54
8	Reeta	9th		89	78	54
9	Arvind	12th	78	78	54
10	Kumar	11th	22	56	54

With Total mark, percentage and Grade
*/
Declare @RollNo Int,
		@Student_name Varchar(100),
		@Mark_Science Int,
		@Marks_Eng Int,
		@Marks_Math Int;

Declare @Marks_Total Int,
		@Percentage Int;

-- Create a cursor
/*
	Is query se Select  rollNo,student_name,marks_science,marks_maths,marks_eng 
				    from Student_details;
	  jo bhi result set avenga
	us par Cursor create karo

	so finally,
	 ye jo map hoke cursor ke sath result set mila usse hum 
	  Active data set kahenge.
*/
Declare student_cursor Cursor for 
                  Select  rollNo,student_name,marks_science,marks_maths,marks_eng 
				    from Student_details;

--Open cursor
Open student_cursor;

/*
 apka pointer abhi Null par hai.
	Ab aap 1st record fetch karne jaa rahe hai
 Null se aage 1st record hai
   so Command is Fetch next
			from cursor Name

   Ab hum jo cursor se data lenge 
     wo apne variable mein rakhenge/map karenge
sequence proper ho	 
*/
Fetch Next from student_cursor 
		Into @RollNo,@Student_name,@Mark_Science,@Marks_Math,@Marks_Eng

/*
	@@FETCH_STATUS ye apna global variable hai
	  ye hume status batata hai
	  yadi -1 status then there is no record in Active data set
	  - if 0 then record exist in active data set
*/
While @@FETCH_STATUS=0
	Begin
		Print Concat('Name: ',@Student_name);
		Print Concat('Roll No: ',@RollNo);
		Print Concat('Science: ',@Mark_Science);
		Print Concat('Maths: ',@Marks_Math);
		Print Concat('English : ',@Marks_Eng);

		Set @Marks_Total = @Mark_Science + @Marks_Eng  + @Marks_Math;
		Print Concat('Total marks : ',@Marks_Total);

		Set @Percentage = @Marks_Total /3;
		Print Concat('Percentage : ',@Percentage);

		If @Percentage > 80
			Begin
				Print 'Grade-A';
			End
		Else If @Percentage > 60 And @Percentage < 80
			Begin
				Print 'Grade-B';
			End
		 Else 
			Begin
				Print 'Grade-C';
			End
			Print '============================'

	-- agian re-fetch
	Fetch Next from student_cursor 
		Into @RollNo,@Student_name,@Mark_Science,@Marks_Math,@Marks_Eng	 

	End  -- end of while loop

-- close and deallocate cursor from memory
Close student_cursor;

Deallocate student_cursor;
/*
Name: Anil
Roll No: 1
Science: 34
Maths: 78
English : 54
Total marks : 166
Percentage : 55
Grade-C
============================
Name: Sunil
Roll No: 2
Science: 78
Maths: 43
English : 87
Total marks : 208
Percentage : 69
Grade-B
============================
Name: Ajay
Roll No: 3
Science: 45
Maths: 32
English : 78
Total marks : 155
Percentage : 51
Grade-C
============================
Name: Vijay
Roll No: 4
Science: 36
Maths: 78
English : 32
Total marks : 146
Percentage : 48
Grade-C
============================
Name: Manoj
Roll No: 5
Science: 12
Maths: 22
English : 67
Total marks : 101
Percentage : 33
Grade-C
============================
Name: Geeta
Roll No: 6
Science: 21
Maths: 65
English : 43
Total marks : 129
Percentage : 43
Grade-C
============================
Name: Sita
Roll No: 7
Science: 34
Maths: 78
English : 54
Total marks : 166
Percentage : 55
Grade-C
============================
Name: Reeta
Roll No: 8
Science: 89
Maths: 78
English : 54
Total marks : 221
Percentage : 73
Grade-B
============================
Name: Arvind
Roll No: 9
Science: 78
Maths: 78
English : 54
Total marks : 210
Percentage : 70
Grade-B
============================
Name: Kumar
Roll No: 10
Science: 22
Maths: 56
English : 54
Total marks : 132
Percentage : 44
Grade-C
============================
*/
```
# 34. CTE in Sql 
![Alt text](image-26.png)

### Why to apply CTE:
- yadi aap window function use karna chahte hai CTE is best approach
- Yadi aapka View complex hai, so you can manage by CTE.

![Alt text](image-27.png)
### Types of CTE
- ***NON recursive*** mein aap single/ multiple CTE create kar sakte
- usse ek temprary result set create hota hai; jaha aap DML statement apply kar sakte ho.

![Alt text](image-28.png)
### CTE Anatomy
- ye col name (Id,Name) optional hai,but if you specify then it should map properly/sequentially in Select statement 

![Alt text](image-29.png)
```sql

```
![Alt text](image-30.png)
### Recursive CTE
- jab hum kisi task ko repeatedly execute karna chahte hai, 1 condition ke sath mein.
- hamare pass mein data hai jo hierachical format mein hai,  1 column like PK kisi dusre column like FK ko refer kar raha hai; waha use kar sakte.

![Alt text](image-31.png)
- cte_query_defiination also called base query/result ek baar execute hoti 
```sql

```
# 35. SQl Parameter Sniffing
- jab aap stored procedure create karte hai, uske andar query ko write karte hai
- then procedure ko aap compile karte hai and then execute karte hai
- to uska ek process hota hai
- Sql optimizer sabse pehele aapke stored procedure ke andar jo parameter hai uska analysis karta hai
- and then based on that parameter analysis it will create a plan.(also called as execution plan)
- us plan ko wo cache ke andar store kar deta hai
- This process is called as paramete sniffing.

![Alt text](image-32.png)
### How store procedure compile

![Alt text](image-33.png)